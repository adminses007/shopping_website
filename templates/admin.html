{% extends "base.html" %}

{% block title %}Order Management - Admin Panel{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-clipboard-list"></i> Order Management</h2>
    <div class="text-muted">
        <i class="fas fa-list"></i> {{ order_groups|length }} unique orders ({{ total_orders }} items)
    </div>
</div>

{% if order_groups %}
    <div class="row">
        {% for group in order_groups %}
        <div class="col-12 mb-4">
            <div class="card admin-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-receipt"></i> Order Number: {{ group.order_number }}
                            {% if group.total_items > 1 %}
                                <span class="badge bg-info ms-2">{{ group.total_items }} items</span>
                            {% endif %}
                        </h5>
                        <small class="text-muted">
                            <i class="fas fa-user"></i> {{ group.user.username }} | 
                            <i class="fas fa-clock"></i> {{ group.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </small>
                    </div>
                    <div>
                        <span class="status-badge status-{{ group.status }}">
                            {% if group.status == 'pending' %}Pending
                            {% elif group.status == 'processing' %}Processing
                            {% elif group.status == 'shipped' %}Shipped
                            {% elif group.status == 'completed' %}Completed
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6><i class="fas fa-shopping-bag"></i> Order Items ({{ group.total_items }})</h6>
                            <div class="row">
                                {% for order in group.all_orders %}
                                <div class="col-md-6 mb-2">
                                    <div class="order-item">
                                        <div class="d-flex align-items-center">
                                            <img src="{{ url_for('static', filename='uploads/' + (order.product.image|get_first_image)) if order.product.image|get_first_image else url_for('static', filename='images/no-image.svg') }}" 
                                                 class="cart-item-image me-3" alt="{{ order.product.name }}">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">
                                                    {{ order.product.name }}
                                                    {% if order.variant %}
                                                    <span class="badge bg-info">{{ order.variant }}</span>
                                                    {% endif %}
                                                </h6>
                                                <p class="mb-0 text-muted">
                                                    Quantity: {{ order.quantity }} | 
                                                    Unit Price: {{ order.product.price|format_currency }} Ks |
                                                    Subtotal: {{ order.total_price|format_currency }} Ks
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="text-primary">{{ group.total_amount|format_currency }} Ks</h4>
                                <p class="text-muted">Total Amount</p>
                                {% if group.total_items > 1 %}
                                    <small class="text-muted">({{ group.total_items }} items)</small>
                                {% endif %}
                            </div>
                            
                            <div class="mt-4">
                                <h6>Order Status Management</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-warning btn-sm" 
                                            onclick="updateAllOrderStatus('{{ group.order_number }}', 'processing')"
                                            {% if group.status == 'processing' %}disabled{% endif %}>
                                        <i class="fas fa-cog"></i> Mark as Processing
                                    </button>
                                    <button class="btn btn-info btn-sm" 
                                            onclick="updateAllOrderStatus('{{ group.order_number }}', 'shipped')"
                                            {% if group.status == 'shipped' %}disabled{% endif %}>
                                        <i class="fas fa-truck"></i> Mark as Shipped
                                    </button>
                                    <button class="btn btn-success btn-sm" 
                                            onclick="updateAllOrderStatus('{{ group.order_number }}', 'completed')"
                                            {% if group.status == 'completed' %}disabled{% endif %}>
                                        <i class="fas fa-check"></i> Mark as Completed
                                    </button>
                                    {% if group.status == 'completed' %}
                                    <button class="btn btn-danger btn-sm" 
                                            onclick="deleteOrder('{{ group.order_number }}')">
                                        <i class="fas fa-trash"></i> Delete Order
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h6>Order Records</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="openRecordModal('{{ group.order_number }}', 'receipt')">
                                        <i class="fas fa-receipt"></i> Upload Receipt
                                    </button>
                                    <button class="btn btn-info btn-sm" 
                                            onclick="openRecordModal('{{ group.order_number }}', 'shipped')">
                                        <i class="fas fa-truck"></i> Upload Shipping Proof
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Order Records Display -->
                            {% if group.records %}
                            <div class="mt-4">
                                <h6><i class="fas fa-images"></i> Records</h6>
                                <div class="order-records" style="max-height: 300px; overflow-y: auto;">
                                    {% for record in group.records %}
                                    <div class="record-item mb-2 p-2 border rounded">
                                        <div class="d-flex align-items-center gap-2">
                                            <img src="{{ url_for('static', filename='uploads/' + record.image_path) }}" 
                                                 class="record-thumbnail" 
                                                 alt="Record"
                                                 onclick="viewRecordImage('{{ url_for('static', filename='uploads/' + record.image_path) }}')"
                                                 style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;">
                                            <div class="flex-grow-1">
                                                <small class="d-block">
                                                    <strong>Type:</strong> 
                                                    {% if record.record_type == 'payment' %}Payment Proof
                                                    {% elif record.record_type == 'receipt' %}Receipt
                                                    {% elif record.record_type == 'shipped' %}Shipping Proof
                                                    {% else %}{{ record.record_type }}{% endif %}
                                                </small>
                                                <small class="d-block text-muted">
                                                    By: {{ record.uploader.username if record.uploader else 'Unknown' }} | 
                                                    {{ record.created_at.strftime('%Y-%m-%d %H:%M') }}
                                                </small>
                                                {% if record.description %}
                                                <small class="d-block text-muted">{{ record.description }}</small>
                                                {% endif %}
                                            </div>
                                            {% if record.record_type != 'payment' %}
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteRecord({{ record.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                <h6>Order Information</h6>
                                <ul class="list-unstyled small">
                                    <li><i class="fas fa-user"></i> User: {{ group.user.username }}</li>
                                    <li><i class="fas fa-envelope"></i> Email: {{ group.user.email }}</li>
                                    <li><i class="fas fa-phone"></i> Phone: {{ group.user.phone }}</li>
                                    <li><i class="fas fa-calendar"></i> Order Time: {{ group.created_at.strftime('%Y-%m-%d %H:%M') }}</li>
                                    <li><i class="fas fa-box"></i> Total Items: {{ group.total_items }}</li>
                                </ul>
                                
                                {% if group.contact_info %}
                                <div class="mt-3">
                                    <h6><i class="fas fa-address-card"></i> Contact Information</h6>
                                    <div class="bg-light p-3 rounded">
                                        <p class="mb-0 text-break">{{ group.contact_info }}</p>
                                    </div>
                                </div>
                                {% else %}
                                <div class="mt-3">
                                    <h6><i class="fas fa-address-card"></i> Contact Information</h6>
                                    <div class="bg-light p-3 rounded">
                                        <p class="mb-0 text-muted"><em>No contact information provided</em></p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        <h3>No Orders</h3>
        <p>No users have placed orders yet, waiting for orders...</p>
    </div>
{% endif %}

<!-- Record Upload Modal -->
<div class="modal fade" id="recordModal" tabindex="-1" aria-labelledby="recordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recordModalLabel">
                    <i class="fas fa-camera"></i> Upload Order Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="record-modal-close-btn"></button>
            </div>
            <div class="modal-body">
                <div id="record-error-message" class="alert alert-danger d-none" role="alert"></div>
                <form id="record-upload-form" enctype="multipart/form-data">
                    <input type="hidden" id="record-order-number" name="order_number" value="">
                    <input type="hidden" id="record-type" name="record_type" value="">
                    
                    <div class="mb-3">
                        <label for="record-type-select" class="form-label">
                            <i class="fas fa-tag"></i> Record Type <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="record-type-select" name="record_type" required>
                            <option value="receipt">Receipt (收据)</option>
                            <option value="shipped">Shipping Proof (发货凭证)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="record-image" class="form-label">
                            <i class="fas fa-image"></i> Select Image <span class="text-danger">*</span>
                        </label>
                        <input type="file" class="form-control" id="record-image" name="image" accept="image/*" required>
                        <div class="form-text">Supported formats: PNG, JPG, JPEG, GIF (Max 16MB)</div>
                        <div id="image-preview-container" class="mt-2" style="display: none;">
                            <img id="image-preview" src="" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="record-description" class="form-label">
                            <i class="fas fa-comment"></i> Description (Optional)
                        </label>
                        <textarea class="form-control" id="record-description" name="description" rows="3" 
                                  placeholder="Add any additional notes about this record..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="record-cancel-btn" style="pointer-events: auto !important; cursor: pointer !important; z-index: 10072 !important; position: relative !important;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="upload-record-btn" style="pointer-events: auto !important; cursor: pointer !important; z-index: 10072 !important; position: relative !important;">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Image View Modal -->
<div class="modal fade" id="imageViewModal" tabindex="-1" aria-labelledby="imageViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewModalLabel">Record Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="view-image" src="" alt="Record Image" style="max-width: 100%; max-height: 70vh;">
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* 确保记录模态框可交互 - 使用最高优先级 */
#recordModal {
    pointer-events: auto !important;
    z-index: 10060 !important;
}

#recordModal .modal-dialog {
    pointer-events: auto !important;
    z-index: 10065 !important;
    position: relative !important;
}

#recordModal .modal-content {
    pointer-events: auto !important;
    z-index: 10070 !important;
    position: relative !important;
}

#recordModal .modal-content * {
    pointer-events: auto !important;
}

#recordModal .modal-content button,
#recordModal .modal-content input,
#recordModal .modal-content textarea,
#recordModal .modal-content select,
#recordModal .modal-content label {
    pointer-events: auto !important;
    z-index: 10071 !important;
    position: relative !important;
}

#recordModal .modal-content button {
    cursor: pointer !important;
}

#recordModal .modal-content input[type="file"] {
    cursor: pointer !important;
}

#recordModal .modal-content textarea {
    cursor: text !important;
}

/* 确保模态框背景不阻止点击 */
#recordModal.modal.show {
    pointer-events: auto !important;
    z-index: 10060 !important;
}

/* 确保 backdrop 不会覆盖模态框内容 */
#recordModal.modal.show ~ .modal-backdrop,
body > .modal-backdrop:last-of-type {
    z-index: 10050 !important;
    pointer-events: none !important;
}

/* 强制所有模态框内的元素可点击 */
#recordModal.modal.show * {
    pointer-events: auto !important;
}
</style>
<script>
// Update all orders with the same order number
function updateAllOrderStatus(orderNumber, status) {
    if (!confirm(`Are you sure you want to update all items in order ${orderNumber} to ${status}?`)) {
        return;
    }

    // Get all order IDs with this order number
    fetch('/admin/get_orders_by_number?order_number=' + encodeURIComponent(orderNumber))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.order_ids.length > 0) {
                // Update each order
                let updatePromises = data.order_ids.map(orderId => {
                    return fetch('/admin/update_order_status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            order_id: orderId,
                            status: status
                        })
                    }).then(response => response.json());
                });

                Promise.all(updatePromises)
                    .then(results => {
                        if (results.every(r => r.success)) {
                            showMessage(`All orders updated to ${status} successfully`, 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showMessage('Some orders failed to update', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Update failed, please try again', 'error');
                    });
            } else {
                showMessage('Order not found', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback: try to update using the first order ID we can find
            showMessage('Failed to get order IDs, please refresh and try again', 'error');
        });
}

// Delete order
function deleteOrder(orderNumber) {
    if (!confirm(`Are you sure you want to delete order ${orderNumber}? This action cannot be undone!`)) {
        return;
    }

    fetch('/admin/delete_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_number: orderNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || 'Order deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showMessage(data.message || 'Delete failed, please try again', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Delete failed: ' + (error.message || 'please try again'), 'error');
    });
}

// Record management functions
function openRecordModal(orderNumber, recordType) {
    document.getElementById('record-order-number').value = orderNumber;
    document.getElementById('record-type').value = recordType;
    document.getElementById('record-type-select').value = recordType;
    document.getElementById('record-upload-form').reset();
    document.getElementById('record-type-select').value = recordType; // Reset after form reset
    document.getElementById('image-preview-container').style.display = 'none';
    document.getElementById('record-error-message').classList.add('d-none');
    
    const modalElement = document.getElementById('recordModal');
    if (!modalElement) {
        console.error('Record modal element not found');
        return;
    }
    
    // Update modal title based on record type
    const modalTitle = document.getElementById('recordModalLabel');
    if (recordType === 'receipt') {
        modalTitle.innerHTML = '<i class="fas fa-receipt"></i> Upload Receipt';
    } else if (recordType === 'shipped') {
        modalTitle.innerHTML = '<i class="fas fa-truck"></i> Upload Shipping Proof';
    } else {
        modalTitle.innerHTML = '<i class="fas fa-camera"></i> Upload Order Record';
    }
    
    // 确保所有按钮和输入框可交互
    function enableInteractions() {
        const buttons = modalElement.querySelectorAll('button');
        const inputs = modalElement.querySelectorAll('input, textarea, select');
        
        buttons.forEach(function(btn) {
            btn.style.pointerEvents = 'auto';
            btn.style.cursor = 'pointer';
            btn.style.zIndex = '9999';
            btn.disabled = false;
            btn.classList.remove('disabled');
        });
        
        inputs.forEach(function(input) {
            input.style.pointerEvents = 'auto';
            input.style.zIndex = '9999';
            input.disabled = false;
            input.readOnly = false;
        });
    }
    
    try {
        // 先启用交互
        enableInteractions();
        
        // 创建或获取模态框实例
        let modal;
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            // 先销毁旧实例（如果存在）
            const oldInstance = bootstrap.Modal.getInstance(modalElement);
            if (oldInstance) {
                oldInstance.dispose();
            }
            
            modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
        } else {
            console.error('Bootstrap Modal is not available');
            return;
        }
        
        // 在显示前强制设置所有样式
        modalElement.style.pointerEvents = 'auto';
        modalElement.style.setProperty('pointer-events', 'auto', 'important');
        modalElement.style.zIndex = '10060';
        modalElement.style.setProperty('z-index', '10060', 'important');
        
        const modalDialog = modalElement.querySelector('.modal-dialog');
        if (modalDialog) {
            modalDialog.style.pointerEvents = 'auto';
            modalDialog.style.setProperty('pointer-events', 'auto', 'important');
            modalDialog.style.zIndex = '10065';
            modalDialog.style.setProperty('z-index', '10065', 'important');
        }
        
        const modalContent = modalElement.querySelector('.modal-content');
        if (modalContent) {
            modalContent.style.pointerEvents = 'auto';
            modalContent.style.setProperty('pointer-events', 'auto', 'important');
            modalContent.style.zIndex = '10070';
            modalContent.style.setProperty('z-index', '10070', 'important');
        }
        
        // 使用 mousedown 事件（在 click 之前触发，更可靠）
        function setupButtonClick(btn, handler, btnName) {
            if (!btn) return;
            
            // 移除所有旧的事件监听器
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // 设置样式
            newBtn.style.pointerEvents = 'auto';
            newBtn.style.setProperty('pointer-events', 'auto', 'important');
            newBtn.style.cursor = 'pointer';
            newBtn.style.zIndex = '10072';
            newBtn.style.setProperty('z-index', '10072', 'important');
            newBtn.style.position = 'relative';
            
            // 使用 mousedown（更早触发，不会被阻止）
            newBtn.addEventListener('mousedown', function(e) {
                console.log(btnName + ' mousedown triggered!');
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                handler();
                return false;
            }, false);
            
            // 同时使用 click 作为备选
            newBtn.addEventListener('click', function(e) {
                console.log(btnName + ' click triggered!');
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                handler();
                return false;
            }, false);
            
            // 设置 onclick 属性（最可靠的方法）
            newBtn.onclick = function(e) {
                console.log(btnName + ' onclick triggered!');
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
                handler();
                return false;
            };
        }
        
        const cancelBtn = modalElement.querySelector('#record-cancel-btn');
        const closeBtn = modalElement.querySelector('#record-modal-close-btn');
        const uploadBtn = modalElement.querySelector('#upload-record-btn');
        
        setupButtonClick(cancelBtn, function() {
            console.log('Cancel button handler executed!');
            modal.hide();
        }, 'Cancel');
        
        setupButtonClick(closeBtn, function() {
            console.log('Close button handler executed!');
            modal.hide();
        }, 'Close');
        
        setupButtonClick(uploadBtn, function() {
            console.log('Upload button handler executed!');
            uploadRecord();
        }, 'Upload');
        
        // 监听模态框显示完成事件
        const shownHandler = function() {
            // 立即修复 aria-hidden 问题（必须在任何其他操作之前）
            modalElement.removeAttribute('aria-hidden');
            modalElement.setAttribute('aria-modal', 'true');
            
            // 强制设置所有元素的样式
            function forceEnableAll() {
                // 先修复 aria-hidden
                modalElement.removeAttribute('aria-hidden');
                modalElement.setAttribute('aria-modal', 'true');
                
                modalElement.style.pointerEvents = 'auto';
                modalElement.style.setProperty('pointer-events', 'auto', 'important');
                modalElement.style.zIndex = '10060';
                modalElement.style.setProperty('z-index', '10060', 'important');
                
                const modalDialog = modalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.pointerEvents = 'auto';
                    modalDialog.style.setProperty('pointer-events', 'auto', 'important');
                    modalDialog.style.zIndex = '10065';
                    modalDialog.style.setProperty('z-index', '10065', 'important');
                }
                
                const modalContent = modalElement.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.pointerEvents = 'auto';
                    modalContent.style.setProperty('pointer-events', 'auto', 'important');
                    modalContent.style.zIndex = '10070';
                    modalContent.style.setProperty('z-index', '10070', 'important');
                }
                
                // 强制设置所有子元素
                const allElements = modalElement.querySelectorAll('*');
                allElements.forEach(function(el) {
                    el.style.pointerEvents = 'auto';
                    el.style.setProperty('pointer-events', 'auto', 'important');
                    if (el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT' || el.tagName === 'LABEL') {
                        el.style.zIndex = '10071';
                        el.style.setProperty('z-index', '10071', 'important');
                        el.style.position = 'relative';
                    }
                });
                
                enableInteractions();
            }
            
            forceEnableAll();
            
            // 确保 backdrop 不会覆盖，并且不阻止点击
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(function(backdrop) {
                backdrop.style.zIndex = '10050';
                backdrop.style.setProperty('z-index', '10050', 'important');
                // 确保 backdrop 不会阻止模态框内容的点击
                backdrop.style.pointerEvents = 'none';
                backdrop.style.setProperty('pointer-events', 'none', 'important');
            });
            
            // 检查是否有其他元素覆盖在模态框上方
            const allOverlays = document.querySelectorAll('*');
            allOverlays.forEach(function(el) {
                const zIndex = window.getComputedStyle(el).zIndex;
                if (zIndex && parseInt(zIndex) > 10070 && el !== modalElement && !modalElement.contains(el)) {
                    console.warn('Found overlay element:', el, 'with z-index:', zIndex);
                    el.style.zIndex = '10000';
                    el.style.setProperty('z-index', '10000', 'important');
                }
            });
        };
        modalElement.addEventListener('shown.bs.modal', shownHandler, { once: true });
        
        // 显示模态框
        modal.show();
        
        // 立即修复 aria-hidden 并强制设置（在显示前）
        setTimeout(function() {
            // 修复 aria-hidden（必须在显示前就修复）
            modalElement.removeAttribute('aria-hidden');
            modalElement.setAttribute('aria-modal', 'true');
            
            const modalDialog = modalElement.querySelector('.modal-dialog');
            const modalContent = modalElement.querySelector('.modal-content');
            if (modalDialog) {
                modalDialog.style.setProperty('pointer-events', 'auto', 'important');
                modalDialog.style.setProperty('z-index', '10065', 'important');
            }
            if (modalContent) {
                modalContent.style.setProperty('pointer-events', 'auto', 'important');
                modalContent.style.setProperty('z-index', '10070', 'important');
            }
            enableInteractions();
            
            // 确保 backdrop 在模态框下方，并且不阻止点击
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(function(backdrop) {
                backdrop.style.zIndex = '10050';
                backdrop.style.setProperty('z-index', '10050', 'important');
                backdrop.style.pointerEvents = 'none';
                backdrop.style.setProperty('pointer-events', 'none', 'important');
            });
        }, 10);
        
        // 延迟再次确保交互性
        setTimeout(function() {
            shownHandler();
        }, 50);
        setTimeout(function() {
            shownHandler();
        }, 150);
        setTimeout(function() {
            shownHandler();
        }, 300);
    } catch (e) {
        console.error('Error opening record modal:', e);
        showMessage('Unable to open dialog, please refresh the page and try again', 'error');
    }
}

// Image preview
document.addEventListener('DOMContentLoaded', function() {
    const recordImageInput = document.getElementById('record-image');
    if (recordImageInput) {
        recordImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('image-preview-container').style.display = 'none';
            }
        });
    }
    
    // Sync record type select with hidden input
    const recordTypeSelect = document.getElementById('record-type-select');
    if (recordTypeSelect) {
        recordTypeSelect.addEventListener('change', function() {
            document.getElementById('record-type').value = this.value;
        });
    }
});

// Upload record
function uploadRecord() {
    const form = document.getElementById('record-upload-form');
    const formData = new FormData(form);
    const uploadBtn = document.getElementById('upload-record-btn');
    const errorDiv = document.getElementById('record-error-message');
    
    // Get record type from select
    const recordType = document.getElementById('record-type-select').value;
    formData.set('record_type', recordType);
    
    // Validate
    if (!formData.get('image') || !formData.get('image').name) {
        errorDiv.textContent = 'Please select an image';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    if (!formData.get('record_type')) {
        errorDiv.textContent = 'Please select a record type';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    // Disable button
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    errorDiv.classList.add('d-none');
    
    fetch('/upload_order_record', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || 'Record uploaded successfully', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('recordModal'));
            modal.hide();
            setTimeout(function() { location.reload(); }, 1000);
        } else {
            errorDiv.textContent = data.message || 'Upload failed';
            errorDiv.classList.remove('d-none');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload';
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        errorDiv.textContent = 'Upload failed: ' + (error.message || 'please try again');
        errorDiv.classList.remove('d-none');
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload';
    });
}

// View record image
function viewRecordImage(imageUrl) {
    document.getElementById('view-image').src = imageUrl;
    const modal = new bootstrap.Modal(document.getElementById('imageViewModal'));
    modal.show();
}

// Delete record
function deleteRecord(recordId) {
    if (!confirm('Are you sure you want to delete this record?')) {
        return;
    }
    
    fetch('/delete_order_record', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            record_id: recordId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(data.message || 'Record deleted successfully', 'success');
            setTimeout(function() { location.reload(); }, 1000);
        } else {
            showMessage(data.message || 'Delete failed, please try again', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showMessage('Delete failed: ' + (error.message || 'please try again'), 'error');
    });
}
</script>
{% endblock %}


{% extends "base.html" %}

{% block title %}Product Management - Admin Panel{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-box"></i> Product Management</h2>
    <a href="{{ url_for('add_product') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Add Product
    </a>
</div>

{% if products %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Product Image</th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Description</th>
                    <th>Created Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr>
                    <td>
                        <img src="{{ url_for('static', filename='uploads/' + (product.image|get_first_image)) if product.image|get_first_image else url_for('static', filename='images/no-image.svg') }}" 
                             class="cart-item-image" alt="{{ product.name }}">
                    </td>
                    <td>
                        <strong>{{ product.name }}</strong>
                    </td>
                    <td>
                        <span class="text-primary fw-bold">{{ product.price|format_currency }} Ks</span>
                    </td>
                    <td>
                        <span class="badge {% if product.stock > 10 %}bg-success{% elif product.stock > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ product.stock }}
                        </span>
                    </td>
                    <td>
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                            {{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">{{ product.created_at.strftime('%Y-%m-%d') }}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary edit-product-btn" data-product-id="{{ product.id }}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-product-btn" data-product-id="{{ product.id }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Product Statistics -->
    <div class="row g-4 mt-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h5 class="card-title text-primary">{{ products|length }}</h5>
                <p class="card-text">Total Products</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h5 class="card-title text-success">{{ products|selectattr('stock', 'gt', 0)|list|length }}</h5>
                <p class="card-text">In Stock Products</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h5 class="card-title text-warning">{{ products|selectattr('stock', 'le', 5)|selectattr('stock', 'gt', 0)|list|length }}</h5>
                <p class="card-text">Low Stock</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h5 class="card-title text-danger">{{ products|selectattr('stock', 'eq', 0)|list|length }}</h5>
                <p class="card-text">Out of Stock Products</p>
            </div>
        </div>
    </div>
{% else %}
    <div class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No Products</h3>
        <p>No products have been added yet, click the button above to add the first product</p>
        <a href="{{ url_for('add_product') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Product
        </a>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function editProduct(productId) {
    // Navigate to edit page
    window.location.href = '/admin/edit_product/' + productId;
}

function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone!')) {
        return;
    }

    fetch('/admin/delete_product', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(function(response) {
        if (!response.ok) {
            return response.text().then(function(text) {
                throw new Error(text || 'HTTP error! status: ' + response.status);
            });
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showMessage(data.message, 'success');
            // Delay page refresh to let user see success message
            setTimeout(function() {
                location.reload();
            }, 1000);
        } else {
            showMessage(data.message || 'Delete failed, please try again', 'error');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        showMessage('Delete failed: ' + (error.message || 'please try again'), 'error');
    });
}

// Bind event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Bind edit product buttons
    const editButtons = document.querySelectorAll('.edit-product-btn');
    editButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            editProduct(parseInt(productId));
        });
    });
    
    // Bind delete product buttons
    const deleteButtons = document.querySelectorAll('.delete-product-btn');
    deleteButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            deleteProduct(parseInt(productId));
        });
    });
});
</script>
{% endblock %}
